# dynamic-mock-api
A Node module for creating a dynamic mock (express) API on the fly. Allows users to monitor requests to the API. Works well with browser driven UI testing.

## Install
```
npm install dynamic-mock-api
```
## Usage
(using mocha, chai, and axios packages)
Write mock responses.
```javascript
// users.mock.js
exports.routes = {
    USERS_POST: {
        url: "/api/users/add",
        method: "post",
        responses: {
            DEFAULT: {
                status: 200,
                body: {
                    name: "Alice",
                    id: 1
                }
            },
        }
    }
};
```
Write tests.
```javascript
// users.spec.js
var mocha = require("mocha");
var chai = require("chai");
var axios = require("axios");
var prom = require("dynamic-mock-api");

describe("Basic test", () => {
    it("Should work", async () => {
        const tokenEndpoint = prom.routes("USERS_POST");
        
        await axios.post("http://localhost:8080/api/users/add", { name: "user" });
        const request = await tokenEndpoint.requests.latest();

        chai.expect(request.body.name).to.equal("user");
        chai.expect(request.response.body.id).to.equal(1);
    });
});
```
Write a apiMock.conf.js.
```javascript
// apiMock.conf.js
module.exports.config = {
    prom: {
        mocks: [
            'users.spec.js'
        ],
        port: 8080
    }
}
```
Run test.
```
mocha --exit
```
Thats it!
## API
### config.prom.mocks string[]
An array of globs which specify where to load the mock files from. All files in the glob must contain a valid mock module.
### config.prom.port number | string
The port on which mock api will run. Default is 3000
### prom.routes(routeKey)
* routeKey _\<string>_
returns an object which represents the mock route selected with _routekey_
### prom.routes(routeKey).set(responseKey)
* responseKey _\<string>_
Uses responseKey to set the response for the selected route.
### prom.routes(routeKey).requests.latest(): Promise\<PromRequest>
returns a promise which resolves to the most recently received request on the selected route. If no requests have been received, the promise will not resolve until a request is received.
### prom.routes(routeKey).requests.first(): Promise\<PromRequest>
returns a promise which resolves to the first received request on the selected route. If no requests have been received, the promise will not resolve until a request is received.
### prom.routes(routeKey).requests.next(): Promise\<PromRequest>
returns a promise which resolves to the next request to be received on the selected route.
### prom.routes(routeKey).requests.all: PromRequest[]
A getter which returns an array of all requests received on the selected route. The requests are ordered from least to most recent.
### prom.reset()
Resets the api to its initial state. Removes all stored requests. Should be called before each test.
### PromRequest
The PromRquest object in typescript
```typescript
PromRequest: {
  body: any,
  headers: express.IncomingHttpHeaders,
  params: any,
  query: any,
  response // The response generated by your mock file.
}

